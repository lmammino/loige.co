---
import Layout from '../../layouts/Layout.astro'

export async function getStaticPaths() {
  const posts = await Astro.glob('../../../content/posts/**/*.(md|mdx)')
  const postsByTags = posts.reduce((map, post) => {
    const tags = post.frontmatter.tags || []
    for (const tag of tags) {
      if (!map.has(tag)) {
        map.set(tag, [])
      }
      map.get(tag).push(post)
    }

    return map
  }, new Map())

  return [...postsByTags].map(([tagId, posts]) => ({
    params: {
      tagId,
    },
    props: {
      posts: posts.sort((a, b) => {
        return new Date(b.frontmatter.date) - new Date(a.frontmatter.date)
      }),
    },
  }))
}

const { tagId } = Astro.params
const { posts } = await Astro.props
---

<Layout title={tagId}>
  <h1>#{tagId}</h1>
  <ul>
    {
      posts.map((post) => (
        <li>
          <a href={`/${post.frontmatter.slug}`}>{post.frontmatter.title}</a>
        </li>
      ))
    }
  </ul>
</Layout>
